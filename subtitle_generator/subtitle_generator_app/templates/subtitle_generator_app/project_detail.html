{% extends 'subtitle_generator_app/base.html' %}

{% block title %}{{ project.name }} - –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –°—É–±—Ç–∏—Ç—Ä–æ–≤{% endblock %}

{% block content %}
<div class="project-detail" data-project-id="{{ project.id }}">
    <div class="project-header">
        <div class="project-header-content">
            <div class="project-title-section">
                <div class="project-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293H15M9 10v4a2 2 0 002 2h2a2 2 0 002-2v-4M9 10V8a2 2 0 012-2h2a2 2 0 012 2v2"></path>
                        <path d="M19 11a7 7 0 10-14 0 7 7 0 0014 0z"></path>
                    </svg>
                </div>
                <div class="project-title-text">
                    <h1 class="project-title">{{ project.name }}</h1>
                    <p class="project-subtitle">–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ</p>
                </div>
            </div>
            <div class="project-status">
                <span class="status-badge status-{{ project.status }}">
                    {{ project.get_status_display }}
                </span>
            </div>
        </div>
    </div>
    
    <div class="project-layout">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - —Å—É–±—Ç–∏—Ç—Ä—ã -->
        <div class="subtitle-column">
            {% if project.subtitle %}
            <div class="content-card">        
                <div id="subtitleContent" class="card-content">
                    
                    <!-- –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
                    <div id="viewMode">
                        <div class="subtitle-timeline" id="subtitleTimeline">
                            <!-- –°—É–±—Ç–∏—Ç—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å—é–¥–∞ -->
                        </div>
                    </div>
                    
                    <!-- –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                    <div id="editMode" class="edit-mode" style="display: none;">
                        <div class="editor-actions">
                            <button type="button" class="btn btn-primary" id="saveBtn">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"></path>
                                    <polyline points="17,21 17,13 7,13 7,21"></polyline>
                                    <polyline points="7,3 7,8 15,8"></polyline>
                                </svg>
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                            <button type="button" class="btn btn-secondary" id="cancelBtn">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                                –û—Ç–º–µ–Ω–∏—Ç—å
                            </button>
                        </div>
                        <textarea id="subtitleEditor" class="subtitle-editor" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—É–±—Ç–∏—Ç—Ä–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ SRT..."></textarea>
                        <div class="help-text">
                            <svg class="help-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                            <strong>–§–æ—Ä–º–∞—Ç SRT:</strong> –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—É–±—Ç–∏—Ç—Ä—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ñ–æ—Ä–º–∞—Ç—É SRT (–Ω–æ–º–µ—Ä, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏, —Ç–µ–∫—Å—Ç).
                        </div>
                    </div>
                    
                    <!-- –°—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
                    <div id="saveStatus" class="status-message" style="display: none;">
                        <div id="saveMessage"></div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="content-card">
                <div class="empty-state">
                <div class="empty-content">
                    <div class="empty-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                            <polyline points="14,2 14,8 20,8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10,9 9,9 8,9"></polyline>
                        </svg>
                    </div>
                    <h3>–°—É–±—Ç–∏—Ç—Ä—ã –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</h3>
                    <p>–°–æ–∑–¥–∞–π—Ç–µ —Å—É–±—Ç–∏—Ç—Ä—ã –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Ö –∑–¥–µ—Å—å</p>
                </div>
                    </div>
                </div>
            {% endif %}
        </div>
        
        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—å –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="info-column">
            <!-- –ê—É–¥–∏–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—å -->
            {% if project.audio %}
            <div class="content-card player-card">
                <div class="card-header">
                    <div class="card-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 18V5l12-2v13"></path>
                            <circle cx="6" cy="18" r="3"></circle>
                            <circle cx="18" cy="16" r="3"></circle>
                        </svg>
                    </div>
                    <div class="card-title-section">
                        <h2 class="card-title">üéµ –ê—É–¥–∏–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—å</h2>
                        <p class="card-subtitle">{{ project.name }}</p>
                    </div>
                </div>
                
                <div class="card-content">
                    <div class="inline-player">
                        <div class="player-time-display">
                            <span id="inlineCurrentTime">00:00</span> / <span id="inlineTotalTime">00:00</span>
                        </div>
                        
                        <div class="inline-progress-container">
                            <div id="inlineProgressBar" class="inline-progress-bar">
                                <div id="inlineProgressFill" class="inline-progress-fill"></div>
                            </div>
                        </div>
                        
                        <div class="inline-controls">
                            <button type="button" id="inlineRewindBtn" class="inline-control-btn" title="–ù–∞–∑–∞–¥ –Ω–∞ 10 —Å–µ–∫—É–Ω–¥">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38"></path>
                                </svg>
                                <span class="skip-time">10</span>
                            </button>
                            
                            <button type="button" id="inlinePlayPauseBtn" class="inline-control-btn primary" title="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏/–ü–∞—É–∑–∞">
                                <svg class="play-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="5,3 19,12 5,21 5,3"></polygon>
                                </svg>
                                <svg class="pause-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                                    <rect x="6" y="4" width="4" height="16"></rect>
                                    <rect x="14" y="4" width="4" height="16"></rect>
                                </svg>
                            </button>
                            
                            <button type="button" id="inlineForwardBtn" class="inline-control-btn" title="–í–ø–µ—Ä–µ–¥ –Ω–∞ 10 —Å–µ–∫—É–Ω–¥">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38"></path>
                                </svg>
                                <span class="skip-time">10</span>
                            </button>
                        </div>
                        
                        <div class="inline-secondary-controls">
                            <button type="button" id="inlineSpeedBtn" class="inline-control-btn speed-btn" title="–°–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è">
                                <span id="inlinePlaybackSpeed">1x</span>
                            </button>
                            
                            <button type="button" id="inlineVolumeBtn" class="inline-control-btn" title="–ì—Ä–æ–º–∫–æ—Å—Ç—å">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="11,5 6,9 2,9 2,15 6,15 11,19 11,5"></polygon>
                                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- –°–∫—Ä—ã—Ç—ã–π –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç -->
                        <audio id="inlineAudioPlayerElement" preload="auto">
                            <source src="{% url 'serve_audio' project.id %}" type="audio/mpeg">
                            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç.
                        </audio>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- –î–µ–π—Å—Ç–≤–∏—è -->
            <div class="content-card">
                <div class="card-header">
                    <div class="card-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                        </svg>
                    </div>
                    <div class="card-title-section">
                        <h2 class="card-title">‚ö° –î–µ–π—Å—Ç–≤–∏—è</h2>
                        <p class="card-subtitle">–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø—Ä–æ–µ–∫—Ç–æ–º</p>
                    </div>
                </div>
                
                <div class="card-content">
                    <div class="actions-list">
                        {% if project.subtitle %}
                            <a href="{% url 'download_subtitle' project.id %}" class="action-btn secondary">
                                <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                                    <polyline points="7,10 12,15 17,10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                –°–∫–∞—á–∞—Ç—å —Å—É–±—Ç–∏—Ç—Ä—ã
                            </a>
                        {% endif %}
                        
                        <a href="{% url 'project_list' %}" class="action-btn secondary">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 12H5M12 19l-7-7 7-7"></path>
                            </svg>
                            –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –ø—Ä–æ–µ–∫—Ç–æ–≤
                        </a>
                    </div>
                    
                    <!-- –°—Ç–∞—Ç—É—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
                    <div id="generationStatus" class="status-message" style="display: none;">
                        <div id="statusMessage"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const projectDetail = document.querySelector('.project-detail');
    const projectId = projectDetail ? projectDetail.dataset.projectId : null;
    
    if (projectId) {
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—É–±—Ç–∏—Ç—Ä–æ–≤
        const generateBtn = document.getElementById('generateBtn');
        if (generateBtn) {
            generateBtn.addEventListener('click', function() {
                generateSubtitles(projectId);
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—è
        initializeInlinePlayer();
        
        // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const saveBtn = document.getElementById('saveBtn');
        if (saveBtn) {
            saveBtn.addEventListener('click', function() {
                saveSubtitleContent(projectId);
            });
        }
        
        // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã
        const cancelBtn = document.getElementById('cancelBtn');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function() {
                exitEditMode();
            });
        }
    }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—è
function initializeInlinePlayer() {
    const audioPlayer = document.getElementById('inlineAudioPlayerElement');
    if (!audioPlayer) return;
    
    const playPauseBtn = document.getElementById('inlinePlayPauseBtn');
    const rewindBtn = document.getElementById('inlineRewindBtn');
    const forwardBtn = document.getElementById('inlineForwardBtn');
    const speedBtn = document.getElementById('inlineSpeedBtn');
    const progressBar = document.getElementById('inlineProgressBar');
    const progressFill = document.getElementById('inlineProgressFill');
    const currentTimeSpan = document.getElementById('inlineCurrentTime');
    const totalTimeSpan = document.getElementById('inlineTotalTime');
    const playbackSpeedSpan = document.getElementById('inlinePlaybackSpeed');
    
    let subtitleBlocks = [];
    let currentActiveBlock = null;
    let playbackSpeeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
    let currentSpeedIndex = 2; // 1x
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
    audioPlayer.addEventListener('loadedmetadata', function() {
        totalTimeSpan.textContent = formatTime(audioPlayer.duration);
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    audioPlayer.addEventListener('timeupdate', function() {
        const currentTime = audioPlayer.currentTime;
        const duration = audioPlayer.duration;
        
        currentTimeSpan.textContent = formatTime(currentTime);
        
        if (duration) {
            const progressPercent = (currentTime / duration) * 100;
            progressFill.style.width = progressPercent + '%';
        }
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å—É–±—Ç–∏—Ç—Ä–∞–º–∏
        updateInlineSubtitleSync(currentTime);
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä—É
    let isDragging = false;

    // Mouse events for desktop
    progressBar.addEventListener('mousedown', function(e) {
        e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
        isDragging = true;
        updateProgress(e);
    });

    document.addEventListener('mousemove', function(e) {
        if (isDragging) {
            updateProgress(e);
        }
    });

    document.addEventListener('mouseup', function() {
        isDragging = false;
    });

    // Touch events for mobile
    progressBar.addEventListener('touchstart', function(e) {
        e.preventDefault();
        isDragging = true;
        updateProgressTouch(e);
    }, { passive: false });

    document.addEventListener('touchmove', function(e) {
        if (isDragging) {
            e.preventDefault();
            updateProgressTouch(e);
        }
    }, { passive: false });

    document.addEventListener('touchend', function(e) {
        isDragging = false;
    });

    // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—ã—Ö–æ–¥–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –æ–∫–Ω–∞
    document.addEventListener('mouseleave', function() {
        if (isDragging) {
            isDragging = false;
        }
    });

    function updateProgress(e) {
        const rect = progressBar.getBoundingClientRect();
        const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
        if (audioPlayer.duration) {
            audioPlayer.currentTime = percent * audioPlayer.duration;
        }
    }

    function updateProgressTouch(e) {
        const rect = progressBar.getBoundingClientRect();
        const touch = e.touches[0] || e.changedTouches[0];
        const percent = Math.max(0, Math.min(1, (touch.clientX - rect.left) / rect.width));
        if (audioPlayer.duration) {
            audioPlayer.currentTime = percent * audioPlayer.duration;
        }
    }
    
    // –ö–Ω–æ–ø–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è/–ø–∞—É–∑—ã
    playPauseBtn.addEventListener('click', function() {
        if (audioPlayer.paused) {
            audioPlayer.play();
        } else {
            audioPlayer.pause();
        }
    });
    
    // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ –Ω–∞ 10 —Å–µ–∫—É–Ω–¥
    rewindBtn.addEventListener('click', function() {
        audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 10);
    });
    
    // –ö–Ω–æ–ø–∫–∞ –≤–ø–µ—Ä–µ–¥ –Ω–∞ 10 —Å–µ–∫—É–Ω–¥
    forwardBtn.addEventListener('click', function() {
        audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 10);
    });
    
    // –ö–Ω–æ–ø–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏
    speedBtn.addEventListener('click', function() {
        currentSpeedIndex = (currentSpeedIndex + 1) % playbackSpeeds.length;
        const newSpeed = playbackSpeeds[currentSpeedIndex];
        audioPlayer.playbackRate = newSpeed;
        playbackSpeedSpan.textContent = newSpeed + 'x';
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ play/pause
    audioPlayer.addEventListener('play', function() {
        const playIcon = playPauseBtn.querySelector('.play-icon');
        const pauseIcon = playPauseBtn.querySelector('.pause-icon');
        playIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
    });
    
    audioPlayer.addEventListener('pause', function() {
        const playIcon = playPauseBtn.querySelector('.play-icon');
        const pauseIcon = playPauseBtn.querySelector('.pause-icon');
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
    });
    
    audioPlayer.addEventListener('ended', function() {
        const playIcon = playPauseBtn.querySelector('.play-icon');
        const pauseIcon = playPauseBtn.querySelector('.pause-icon');
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
        
        // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–ª–æ–∫–∞
        if (currentActiveBlock) {
            currentActiveBlock.classList.remove('active');
            currentActiveBlock = null;
        }
    });
    
    // –§—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å—É–±—Ç–∏—Ç—Ä–∞–º–∏
    function updateInlineSubtitleSync(currentTime) {
        if (subtitleBlocks.length === 0) return;
        
        const activeBlock = findInlineActiveSubtitleBlock(currentTime);
        
        if (activeBlock && activeBlock !== currentActiveBlock) {
            if (currentActiveBlock) {
                currentActiveBlock.classList.remove('active');
            }
            
            activeBlock.classList.add('active');
            currentActiveBlock = activeBlock;
            scrollToInlineActiveBlock(activeBlock);
        } else if (!activeBlock && currentActiveBlock) {
            currentActiveBlock.classList.remove('active');
            currentActiveBlock = null;
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–ª–æ–∫–∞ —Å—É–±—Ç–∏—Ç—Ä–æ–≤
    function findInlineActiveSubtitleBlock(currentTime) {
        for (let block of subtitleBlocks) {
            const startTime = parseTime(block.dataset.startTime);
            const endTime = parseTime(block.dataset.endTime);
            
            if (currentTime >= startTime && currentTime <= endTime) {
                return block;
            }
        }
        return null;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    function scrollToInlineActiveBlock(block) {
        const container = document.querySelector('.subtitle-column .card-content');
        if (container) {
            const blockTop = block.offsetTop;
            const containerHeight = container.clientHeight;
            const blockHeight = block.clientHeight;
            
            const scrollTop = blockTop - (containerHeight / 2) + (blockHeight / 2);
            
            container.scrollTo({
                top: Math.max(0, scrollTop),
                behavior: 'smooth'
            });
        }
    }
    
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    window.inlinePlayerFunctions = {
        setSubtitleBlocks: function(blocks) {
            subtitleBlocks = blocks;
        }
    };
}

function generateSubtitles(projectId) {
    const btn = document.getElementById('generateBtn');
    const statusDiv = document.getElementById('generationStatus');
    const statusMessage = document.getElementById('statusMessage');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
    statusDiv.style.display = 'block';
    statusDiv.className = 'status-message loading';
    statusMessage.innerHTML = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—É–±—Ç–∏—Ç—Ä–æ–≤ –Ω–∞—á–∞–ª–∞—Å—å...';
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É
    btn.disabled = true;
    btn.innerHTML = '<svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg> –ì–µ–Ω–µ—Ä–∏—Ä—É—é...';
    
    // –î–µ–ª–∞–µ–º AJAX –∑–∞–ø—Ä–æ—Å
    fetch(`/api/project/${projectId}/generate-subtitles/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.className = 'status-message success';
            statusMessage.innerHTML = data.message;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            statusDiv.className = 'status-message error';
            statusMessage.innerHTML = '–û—à–∏–±–∫–∞: ' + data.error;
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É
            btn.disabled = false;
            btn.innerHTML = '<svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg> –°–æ–∑–¥–∞—Ç—å —Å—É–±—Ç–∏—Ç—Ä—ã';
        }
    })
    .catch(error => {
        statusDiv.className = 'status-message error';
        statusMessage.innerHTML = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É
        btn.disabled = false;
        btn.innerHTML = '<svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg> –°–æ–∑–¥–∞—Ç—å —Å—É–±—Ç–∏—Ç—Ä—ã';
    });
}

function loadSubtitleContent(projectId) {
    const contentDiv = document.getElementById('subtitleContent');
    const timelineDiv = document.getElementById('subtitleTimeline');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    const loadBtn = document.getElementById('loadSubtitleBtn');
    if (loadBtn) {
        loadBtn.disabled = true;
        loadBtn.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∂–∞—é...';
    }
    
    // –î–µ–ª–∞–µ–º AJAX –∑–∞–ø—Ä–æ—Å
    fetch(`/api/project/${projectId}/subtitle-content/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—É–±—Ç–∏—Ç—Ä–æ–≤ –≤ –≤–∏–¥–µ –±–ª–æ–∫–æ–≤
            const subtitleBlocks = parseSubtitleBlocks(data.content);
            renderSubtitleBlocks(subtitleBlocks, timelineDiv);
            
            contentDiv.style.display = 'block';
            if (loadBtn) {
                loadBtn.style.display = 'none';
            }
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
            if (loadBtn) {
                loadBtn.disabled = false;
                loadBtn.innerHTML = 'üìñ –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ';
            }
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        if (loadBtn) {
            loadBtn.disabled = false;
            loadBtn.innerHTML = 'üìñ –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ';
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ SRT-—Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –Ω–∞ –±–ª–æ–∫–∏
function parseSubtitleBlocks(content) {
    const blocks = [];
    const entries = content.split(/\n\s*\n/).filter(entry => entry.trim());
    
    entries.forEach((entry, index) => {
        const lines = entry.split('\n');
        const number = lines[0] ? lines[0].trim() : (index + 1).toString();
        const timecode = lines[1] ? lines[1].trim() : '';
        const text = lines.slice(2).join(' ').trim();
        
        if (timecode && text) {
            blocks.push({
                number: number,
                timecode: timecode,
                text: text
            });
        }
    });
    
    return blocks;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–ª–æ–∫–æ–≤ —Å—É–±—Ç–∏—Ç—Ä–æ–≤
function renderSubtitleBlocks(blocks, container) {
    container.innerHTML = '';
    const blockElements = [];
    
    blocks.forEach((block, index) => {
        const blockElement = document.createElement('div');
        blockElement.className = 'subtitle-block';
        blockElement.draggable = true;
        blockElement.dataset.index = index;
        
        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞ and –æ–∫–æ–Ω—á–∞–Ω–∏—è
        const times = block.timecode.split(' --> ');
        const startTime = times[0] ? times[0].trim() : '';
        const endTime = times[1] ? times[1].trim() : '';
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –≤ data –∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –∞—É–¥–∏–æ
        blockElement.dataset.startTime = startTime;
        blockElement.dataset.endTime = endTime;
        
        blockElement.innerHTML = `
            <div class="block-header">
                <span class="block-number">${block.number}</span>
                <div class="block-times">
                    <span class="time-start" contenteditable="false">${startTime}</span>
                    <span class="time-arrow">‚Üí</span>
                    <span class="time-end" contenteditable="false">${endTime}</span>
                </div>
                <div class="block-actions">
                    <button type="button" class="btn-action edit-block" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button type="button" class="btn-action delete-block" title="–£–¥–∞–ª–∏—Ç—å">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3,6 5,6 21,6"></polyline>
                            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="block-content" contenteditable="false">${block.text}</div>
        `;
        
        blockElements.push(blockElement);
        container.appendChild(blockElement);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞ after –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞, –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ
        if (index < blocks.length - 1) {
            const addBlockButton = document.createElement('div');
            addBlockButton.className = 'add-block-button';
            addBlockButton.innerHTML = `
                <div class="divider-line">
                    <span class="divider-dash"></span>
                    <button type="button" class="btn-add-block" title="–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫">–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫</button>
                    <span class="divider-dash"></span>
                </div>
            `;
            addBlockButton.dataset.index = index;
            container.appendChild(addBlockButton);
        }
    });
    
    // –ü–µ—Ä–µ–¥–∞–µ–º –±–ª–æ–∫–∏ –≤–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—å –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    if (window.inlinePlayerFunctions) {
        window.inlinePlayerFunctions.setSubtitleBlocks(blockElements);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    addDragAndDropHandlers(container);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ for –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –∏ –¥—Ä—É–≥–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
    addBlockEventHandlers(container);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ for –∫–Ω–æ–ø–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–æ–≤
    addAddBlockButtonHandlers(container);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
function addDragAndDropHandlers(container) {
    let draggedElement = null;
    
    container.addEventListener('dragstart', (e) => {
        draggedElement = e.target;
        e.target.classList.add('dragging');
    });
    
    container.addEventListener('dragend', (e) => {
        e.target.classList.remove('dragging');
        draggedElement = null;
    });
    
    container.addEventListener('dragover', (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(container, e.clientY);
        if (afterElement == null) {
            container.appendChild(draggedElement);
        } else {
            container.insertBefore(draggedElement, afterElement);
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞, after –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–π —ç–ª–µ–º–µ–Ω—Ç
function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.subtitle-block:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–æ–≤
function addBlockEditHandlers(container) {
    container.addEventListener('click', (e) => {
        const block = e.target.closest('.subtitle-block');
        if (!block) return;
        
        if (e.target.classList.contains('edit-block')) {
            toggleBlockEditMode(block);
        } else if (e.target.classList.contains('delete-block')) {
            deleteBlock(block);
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è for –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–∞
function toggleBlockEditMode(block) {
    const contentDiv = block.querySelector('.block-content');
    const timeStartDiv = block.querySelector('.time-start');
    const timeEndDiv = block.querySelector('.time-end');
    const isEditing = contentDiv.contentEditable === 'true';
    
    if (isEditing) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        saveBlockChanges(block);
        contentDiv.contentEditable = 'false';
        timeStartDiv.contentEditable = 'false';
        timeEndDiv.contentEditable = 'false';
        contentDiv.classList.remove('editing');
        timeStartDiv.classList.remove('editing');
        timeEndDiv.classList.remove('editing');
    } else {
        // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        contentDiv.contentEditable = 'true';
        timeStartDiv.contentEditable = 'true';
        timeEndDiv.contentEditable = 'true';
        contentDiv.classList.add('editing');
        timeStartDiv.classList.add('editing');
        timeEndDiv.classList.add('editing');
        contentDiv.focus();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–ª–æ–∫–∞
function saveBlockChanges(block) {
    const projectId = document.querySelector('.project-detail').dataset.projectId;
    const blocks = document.querySelectorAll('.subtitle-block');
    let content = '';
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –±–ª–æ–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç SRT
    blocks.forEach((block, index) => {
        const number = block.querySelector('.block-number').textContent;
        const timeStart = block.querySelector('.time-start').textContent;
        const timeEnd = block.querySelector('.time-end').textContent;
        const text = block.querySelector('.block-content').textContent;
        
        content += `${number}\n${timeStart} --> ${timeEnd}\n${text}\n\n`;
    });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch(`/api/project/${projectId}/update-subtitle/`, {
        method: 'PUT',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–∫–∏ –≤–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            if (window.inlinePlayerFunctions) {
                const blockElements = document.querySelectorAll('.subtitle-block');
                window.inlinePlayerFunctions.setSubtitleBlocks(Array.from(blockElements));
            }
        } else {
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + data.error);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –±–ª–æ–∫–∞
function deleteBlock(block) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–ª–æ–∫ —Å—É–±—Ç–∏—Ç—Ä–æ–≤?')) {
        // –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –°–¢–†–û–ö–£:
        const container = document.getElementById('subtitleTimeline'); 

        // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞
        const nextButton = block.nextElementSibling;
        if (nextButton && nextButton.classList.contains('add-block-button')) {
            nextButton.remove();
        }
        
        // –£–¥–∞–ª—è–µ–º —Å–∞–º –±–ª–æ–∫
        block.remove();
        
        // –¢–µ–ø–µ—Ä—å container –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –∏ –∫–æ–¥ –Ω–∏–∂–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
        updateBlockNumbers(container);
        
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è after —É–¥–∞–ª–µ–Ω–∏—è –±–ª–æ–∫–∞
        const projectId = document.querySelector('.project-detail').dataset.projectId;
        const blocks = document.querySelectorAll('.subtitle-block');
        let content = '';
        
        // –°–æ–±–∏—Ä–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –±–ª–æ–∫–∏
        blocks.forEach((block, index) => {
            const number = block.querySelector('.block-number').textContent;
            const timeStart = block.querySelector('.time-start').textContent;
            const timeEnd = block.querySelector('.time-end').textContent;
            const text = block.querySelector('.block-content').textContent;
            
            content += `${number}\n${timeStart} --> ${timeEnd}\n${text}\n\n`;
        });
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch(`/api/project/${projectId}/update-subtitle/`, {
            method: 'PUT',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content: content
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('–ë–ª–æ–∫ —É–¥–∞–ª–µ–Ω and –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–∫–∏ –≤–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                if (window.inlinePlayerFunctions) {
                    const allBlocks = container.querySelectorAll('.subtitle-block');
                    const blockElements = Array.from(allBlocks);
                    window.inlinePlayerFunctions.setSubtitleBlocks(blockElements);
                }
            } else {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + data.error);
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        container.addEventListener('blur', (e) => {
            const block = e.target.closest('.subtitle-block');
            if (!block) return;
            
            const contentDiv = block.querySelector('.block-content');
            const timeStartDiv = block.querySelector('.time-start');
            const timeEndDiv = block.querySelector('.time-end');
            
            if (contentDiv.contentEditable === 'true' ||
                timeStartDiv.contentEditable === 'true' ||
                timeEndDiv.contentEditable === 'true') {
                toggleBlockEditMode(block);
            }
        }, true);
    }
}

function enterEditMode() {
    const viewMode = document.getElementById('viewMode');
    const editMode = document.getElementById('editMode');
    const subtitleEditor = document.getElementById('subtitleEditor');
    
    // –°–æ–±–∏—Ä–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ –±–ª–æ–∫–æ–≤
    const blocks = document.querySelectorAll('.subtitle-block');
    let content = '';
    
    blocks.forEach((block, index) => {
        const number = block.querySelector('.block-number').textContent;
        const timeStart = block.querySelector('.time-start').textContent;
        const timeEnd = block.querySelector('.time-end').textContent;
        const text = block.querySelector('.block-content').textContent;
        
        content += `${number}\n${timeStart} --> ${timeEnd}\n${text}\n\n`;
    });
    
    // –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
    subtitleEditor.value = content;
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º—ã
    viewMode.style.display = 'none';
    editMode.style.display = 'block';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –±–ª–æ–∫–æ–≤
function addBlockEventHandlers(container) {
    container.addEventListener('dblclick', (e) => {
        const block = e.target.closest('.subtitle-block');
        if (!block) return;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –±—ã–ª –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É –±–ª–æ–∫–∞ or –≤—Ä–µ–º–µ–Ω–∏
        if (e.target.classList.contains('block-content') ||
            e.target.classList.contains('time-start') ||
            e.target.classList.contains('time-end')) {
            toggleBlockEditMode(block);
        }
    });
    
    container.addEventListener('click', (e) => {
        const block = e.target.closest('.subtitle-block');
        if (!block) return;
        
        if (e.target.classList.contains('edit-block') || e.target.closest('.edit-block')) {
            toggleBlockEditMode(block);
        } else if (e.target.classList.contains('delete-block') || e.target.closest('.delete-block')) {
            deleteBlock(block);
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–Ω–æ–ø–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–æ–≤
function addAddBlockButtonHandlers(container) {
    container.addEventListener('click', (e) => {
        const addButton = e.target.closest('.btn-add-block');
        if (!addButton) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å –±–ª–æ–∫–∞, after –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π
        const buttonContainer = addButton.closest('.add-block-button');
        const insertIndex = parseInt(buttonContainer.dataset.index) + 1;
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –±–ª–æ–∫
        createNewSubtitleBlock(container, insertIndex);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞ —Å—É–±—Ç–∏—Ç—Ä–æ–≤
function createNewSubtitleBlock(container, insertIndex) {
    const blocks = document.querySelectorAll('.subtitle-block');
    
    if (blocks.length === 0) {
        // –ï—Å–ª–∏ –Ω–µ—Ç –±–ª–æ–∫–æ–≤, —Å–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤—ã–π
        const newBlock = createSubtitleBlockElement(1, '00:00:01,000', '00:00:03,000', '–ù–æ–≤—ã–π –±–ª–æ–∫');
        container.appendChild(newBlock);
        updateBlockNumbers(container);
        saveAllBlocks(container);
        return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ —Å–æ—Å–µ–¥–Ω–∏—Ö –±–ª–æ–∫–æ–≤
    const prevBlock = insertIndex > 0 ? blocks[insertIndex - 1] : null;
    const nextBlock = insertIndex < blocks.length ? blocks[insertIndex] : null;
    
    // –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞
    const { startTime, endTime } = calculateNewBlockTimes(prevBlock, nextBlock);
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –±–ª–æ–∫
    const newBlockNumber = insertIndex + 1;
    const newBlock = createSubtitleBlockElement(newBlockNumber, startTime, endTime, '–ù–æ–≤—ã–π –±–ª–æ–∫');
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –±–ª–æ–∫
    if (insertIndex < blocks.length) {
        container.insertBefore(newBlock, blocks[insertIndex]);
    } else {
        container.appendChild(newBlock);
    }
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞ (–µ—Å–ª–∏ –æ–Ω –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π)
    if (insertIndex < blocks.length - 1 || blocks.length === 0) {
        const addBlockButton = document.createElement('div');
        addBlockButton.className = 'add-block-button';
        addBlockButton.innerHTML = `
            <button type="button" class="btn-add-block" title="–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 4v16m8-8H4"></path>
                </svg>
            </button>
        `;
        addBlockButton.dataset.index = insertIndex;
        if (insertIndex < blocks.length) {
            container.insertBefore(addBlockButton, blocks[insertIndex]);
        } else {
            container.appendChild(addBlockButton);
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤
    updateBlockNumbers(container);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    saveAllBlocks(container);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–∫–∏ –≤–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    if (window.inlinePlayerFunctions) {
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –±–ª–æ–∫–∏ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ
        const allBlocks = container.querySelectorAll('.subtitle-block');
        const blockElements = Array.from(allBlocks);
        window.inlinePlayerFunctions.setSubtitleBlocks(blockElements);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞
function calculateNewBlockTimes(prevBlock, nextBlock) {
    const oneSecond = 1000; // 1 —Å–µ–∫—É–Ω–¥–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
    const twoSeconds = 2000; // 2 —Å–µ–∫—É–Ω–¥—ã –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
    
    if (!prevBlock && !nextBlock) {
        // –ü–µ—Ä–≤—ã–π –±–ª–æ–∫
        return {
            startTime: '00:00:01,000',
            endTime: '00:00:03,000'
        };
    }
    
    if (!prevBlock) {
        // –ü–µ—Ä–≤—ã–π –±–ª–æ–∫, –µ—Å—Ç—å —Å–ª–µ–¥—É—é—â–∏–π
        const nextStartTime = parseTimeString(nextBlock.dataset.startTime);
        const newEndTime = nextStartTime;
        const newStartTime = Math.max(0, newEndTime - twoSeconds);
        
        return {
            startTime: formatTimeForSRT(newStartTime),
            endTime: formatTimeForSRT(newEndTime)
        };
    }
    
    if (!nextBlock) {
        // –ü–æ—Å–ª–µ–¥–Ω–∏–π –±–ª–æ–∫, –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π
        const prevEndTime = parseTimeString(prevBlock.dataset.endTime);
        const newStartTime = prevEndTime + oneSecond;
        const newEndTime = newStartTime + twoSeconds;
        
        return {
            startTime: formatTimeForSRT(newStartTime),
            endTime: formatTimeForSRT(newEndTime)
        };
    }
    
    // –ë–ª–æ–∫ –º–µ–∂–¥—É –¥–≤—É–º—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏
    const prevEndTime = parseTimeString(prevBlock.dataset.endTime);
    const nextStartTime = parseTimeString(nextBlock.dataset.startTime);
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Å–µ—Ä–µ–¥–∏–Ω—É –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏
    const midTime = prevEndTime + (nextStartTime - prevEndTime) / 2;
    const newStartTime = Math.max(prevEndTime + oneSecond, midTime - oneSecond);
    const newEndTime = Math.min(nextStartTime - oneSecond, midTime + oneSecond);
    
    return {
        startTime: formatTimeForSRT(newStartTime),
        endTime: formatTimeForSRT(newEndTime)
    };
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
function parseTimeString(timeString) {
    if (!timeString) return 0;
    
    const parts = timeString.split(':');
    const hours = parseInt(parts[0]) || 0;
    const minutes = parseInt(parts[1]) || 0;
    const secondsAndMs = (parts[2] || '0').split(',');
    const seconds = parseInt(secondsAndMs[0]) || 0;
    const milliseconds = parseInt(secondsAndMs[1]) || 0;
    
    return (hours * 3600 + minutes * 60 + seconds) * 1000 + milliseconds;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ —Ñ–æ—Ä–º–∞—Ç SRT
function formatTimeForSRT(milliseconds) {
    const totalSeconds = Math.floor(milliseconds / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    const millisecondsRemainder = milliseconds % 1000;
    
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')},${millisecondsRemainder.toString().padStart(3, '0')}`;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –±–ª–æ–∫–∞ —Å—É–±—Ç–∏—Ç—Ä–æ–≤
function createSubtitleBlockElement(number, startTime, endTime, text) {
    const blockElement = document.createElement('div');
    blockElement.className = 'subtitle-block';
    blockElement.draggable = true;
    blockElement.dataset.startTime = startTime;
    blockElement.dataset.endTime = endTime;
    
    blockElement.innerHTML = `
        <div class="block-header">
            <span class="block-number">${number}</span>
            <div class="block-times">
                <span class="time-start" contenteditable="false">${startTime}</span>
                <span class="time-arrow">‚Üí</span>
                <span class="time-end" contenteditable="false">${endTime}</span>
            </div>
            <div class="block-actions">
                <button type="button" class="btn-action edit-block" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
                <button type="button" class="btn-action delete-block" title="–£–¥–∞–ª–∏—Ç—å">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3,6 5,6 21,6"></polyline>
                        <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </button>
            </div>
        </div>
        <div class="block-content" contenteditable="false">${text}</div>
    `;
    
    return blockElement;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫–æ–≤
function updateBlockNumbers(container) {
    const blocks = container.querySelectorAll('.subtitle-block');
    blocks.forEach((block, index) => {
        const numberElement = block.querySelector('.block-number');
        if (numberElement) {
            numberElement.textContent = (index + 1).toString();
        }
        block.dataset.index = index;
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
function saveAllBlocks(container) {
    const projectId = document.querySelector('.project-detail').dataset.projectId;
    const blocks = container.querySelectorAll('.subtitle-block');
    let content = '';
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –±–ª–æ–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç SRT
    blocks.forEach((block, index) => {
        const number = block.querySelector('.block-number').textContent;
        const timeStart = block.querySelector('.time-start').textContent;
        const timeEnd = block.querySelector('.time-end').textContent;
        const text = block.querySelector('.block-content').textContent;
        
        content += `${number}\n${timeStart} --> ${timeEnd}\n${text}\n\n`;
    });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch(`/api/project/${projectId}/update-subtitle/`, {
        method: 'PUT',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('–ë–ª–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
        } else {
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + data.error);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    });
}

function exitEditMode() {
    const viewMode = document.getElementById('viewMode');
    const editMode = document.getElementById('editMode');
    const saveStatus = document.getElementById('saveStatus');
    
    // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    saveStatus.style.display = 'none';
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º—ã
    editMode.style.display = 'none';
    viewMode.style.display = 'block';
}

function saveSubtitleContent(projectId) {
    const subtitleEditor = document.getElementById('subtitleEditor');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveStatus = document.getElementById('saveStatus');
    const saveMessage = document.getElementById('saveMessage');
    
    const newContent = subtitleEditor.value;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    if (!newContent.trim()) {
        saveStatus.style.display = 'block';
        saveStatus.className = 'status-message error';
        saveMessage.innerHTML = '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º';
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
    saveStatus.style.display = 'block';
    saveStatus.className = 'status-message loading';
    saveMessage.innerHTML = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π...';
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
    saveBtn.disabled = true;
    cancelBtn.disabled = true;
    
    // –î–µ–ª–∞–µ–º AJAX –∑–∞–ø—Ä–æ—Å
    fetch(`/api/project/${projectId}/update-subtitle/`, {
        method: 'PUT',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            content: newContent
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            saveStatus.className = 'status-message success';
            saveMessage.innerHTML = data.message;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            const subtitleBlocks = parseSubtitleBlocks(newContent);
            const timelineDiv = document.getElementById('subtitleTimeline');
            renderSubtitleBlocks(subtitleBlocks, timelineDiv);
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                exitEditMode();
                saveBtn.disabled = false;
                cancelBtn.disabled = false;
            }, 1000);
        } else {
            saveStatus.className = 'status-message error';
            saveMessage.innerHTML = '–û—à–∏–±–∫–∞: ' + data.error;
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫–∏
            saveBtn.disabled = false;
            cancelBtn.disabled = false;
        }
    })
    .catch(error => {
        saveStatus.className = 'status-message error';
        saveMessage.innerHTML = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫–∏
        saveBtn.disabled = false;
        cancelBtn.disabled = false;
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—Ä–µ–º–µ–Ω–µ–º
function formatTime(seconds) {
    if (isNaN(seconds)) return '00:00.000';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    const milliseconds = Math.floor((seconds % 1) * 1000);
    
    if (hours > 0) {
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${milliseconds.toString().padStart(3, '0')}`;
    } else {
        return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${milliseconds.toString().padStart(3, '0')}`;
    }
}

function parseTime(timeString) {
    // –ü–∞—Ä—Å–∏—Ç –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM:SS.mmm –∏–ª–∏ MM:SS.mmm –≤ —Å–µ–∫—É–Ω–¥—ã
    const parts = timeString.split(':');
    if (parts.length === 2) {
        // MM:SS.mmm
        const minutes = parseInt(parts[0]);
        const seconds = parseFloat(parts[1]);
        return minutes * 60 + seconds;
    } else if (parts.length === 3) {
        // HH:MM:SS.mmm
        const hours = parseInt(parts[0]);
        const minutes = parseInt(parts[1]);
        const seconds = parseFloat(parts[2]);
        return hours * 3600 + minutes * 60 + seconds;
    }
    return 0;
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—É–±—Ç–∏—Ç—Ä–æ–≤ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞
document.addEventListener('DOMContentLoaded', function() {
    const projectDetail = document.querySelector('.project-detail');
    const projectId = projectDetail ? projectDetail.dataset.projectId : null;
    
    if (projectId && document.getElementById('subtitleContent')) {
        setTimeout(() => {
            loadSubtitleContent(projectId);
        }, 100);
    }
});
</script>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–µ—Ç–∞–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞ */
.project-detail {
    max-width: 1200px;
    margin: 0 auto;
}

.project-layout {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 24px;
    margin-top: 24px;
}

.subtitle-column {
    order: 1;
    display: flex;
    flex-direction: column;
    height: 600px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –ª–µ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ */
}

.subtitle-column .content-card {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.subtitle-column .card-content {
    flex: 1;
    overflow-y: auto; /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
    padding: 24px;
    /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
}

.subtitle-column .card-content::-webkit-scrollbar {
    width: 8px;
}

.subtitle-column .card-content::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}

.subtitle-column .card-content::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
}

.subtitle-column .card-content::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤—ã—Å–æ—Ç–µ */
.subtitle-column .empty-state {
    flex: 1;
}

.info-column {
    order: 2;
}

/* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—å */
.player-card .card-content {
    padding: 20px;
}

.inline-player {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.player-time-display {
    text-align: center;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    color: #6b7280;
    font-weight: 500;
}

.inline-progress-container {
    width: 100%;
}

.inline-progress-bar {
    width: 100%;
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.inline-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
    border-radius: 3px;
    width: 0%;
    transition: width 0.1s ease;
}

.inline-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
}

.inline-control-btn {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    padding: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    min-width: 40px;
    height: 40px;
}

.inline-control-btn:hover {
    background: #f8fafc;
    border-color: #d1d5db;
    transform: translateY(-1px);
}

.inline-control-btn.primary {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    border-color: #4f46e5;
    color: white;
    min-width: 48px;
    height: 48px;
}

.inline-control-btn.primary:hover {
    background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
}

.inline-control-btn svg {
    width: 16px;
    height: 16px;
}

.inline-control-btn.primary svg {
    width: 20px;
    height: 20px;
}

.inline-secondary-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.inline-control-btn.speed-btn {
    font-weight: 600;
    font-size: 11px;
}

.skip-time {
    position: absolute;
    font-size: 8px;
    font-weight: 700;
    bottom: 2px;
    right: 2px;
    background: rgba(255, 255, 255, 0.9);
    color: #4f46e5;
    padding: 1px 3px;
    border-radius: 3px;
    line-height: 1;
}

.inline-control-btn .skip-time {
    font-size: 7px;
    bottom: 1px;
    right: 1px;
}

.control-btn {
    position: relative;
}

.inline-control-btn {
    position: relative;
}

/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞ */
.project-header {
    margin-bottom: 32px;
}

.project-header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 24px;
    flex-wrap: wrap;
}

.project-title-section {
    display: flex;
    align-items: center;
    gap: 16px;
}

.project-icon {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
}

.project-icon svg {
    width: 28px;
    height: 28px;
}

.project-title-text {
    flex: 1;
}

.project-title {
    font-size: 2rem;
    font-weight: 700;
    color: #1a202c;
    margin: 0 0 4px 0;
    letter-spacing: -0.025em;
}

.project-subtitle {
    font-size: 1rem;
    color: #6b7280;
    margin: 0;
}

/* –ö–∞—Ä—Ç–æ—á–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
.content-card {
    background: white;
    border-radius: 16px;
    border: 1px solid #e5e7eb;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    position: relative;
    margin-bottom: 24px;
}

.content-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
}

.card-header {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    padding: 24px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 16px;
}

.card-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
}

.card-icon svg {
    width: 24px;
    height: 24px;
}

.card-title-section {
    flex: 1;
}

.card-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1a202c;
    margin: 0 0 4px 0;
}

.card-subtitle {
    font-size: 14px;
    color: #6b7280;
    margin: 0;
}

.card-content {
    padding: 24px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
.empty-state {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    background: white;
    border-radius: 16px;
    border: 2px dashed #e5e7eb;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.empty-content {
    text-align: center;
    padding: 40px 20px;
}

.empty-icon {
    width: 80px;
    height: 80px;
    background: #f3f4f6;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 24px;
    color: #9ca3af;
}

.empty-icon svg {
    width: 40px;
    height: 40px;
}

.empty-content h3 {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1a202c;
    margin: 0 0 8px 0;
}

.empty-content p {
    color: #6b7280;
    margin: 0;
    font-size: 1rem;
}

/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ */
.info-section {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: #f8fafc;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}

.info-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
}

.info-icon svg {
    width: 20px;
    height: 20px;
}

.info-content {
    flex: 1;
}

.info-label {
    font-size: 14px;
    font-weight: 500;
    color: #6b7280;
    margin-bottom: 2px;
}

.info-value {
    font-size: 16px;
    font-weight: 600;
    color: #1a202c;
}

/* –î–µ–π—Å—Ç–≤–∏—è */
.actions-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    border-radius: 12px;
    text-decoration: none;
    font-weight: 500;
    font-size: 14px;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
    justify-content: flex-start;
}

.action-btn.primary {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
}

.action-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4);
}

.action-btn.secondary {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
}

.action-btn.secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(107, 114, 128, 0.4);
}

.action-icon {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
}

/* –°—É–±—Ç–∏—Ç—Ä—ã */








.subtitle-timeline {
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.subtitle-block {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

.subtitle-block::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
}

.subtitle-block:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    border-color: #d1d5db;
}

.subtitle-block.dragging {
    opacity: 0.5;
    border-color: #4f46e5;
}

.subtitle-block.active {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border-color: #3b82f6;
    transform: scale(1.02);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
    position: relative;
}

.subtitle-block.active::before {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
}

.subtitle-block.active .block-number {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

.subtitle-block.active .block-content {
    color: #1e40af;
    font-weight: 500;
}

/* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–ª–æ–∫–∞ */
.subtitle-timeline {
    scroll-behavior: smooth;
}

.subtitle-block.active {
    scroll-margin: 100px 0;
}

/* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞ */
.add-block-button {
    display: flex;
    justify-content: center;
    margin: 0;
    opacity: 0;
    transition: opacity 0.2s ease;
    height: auto;
    min-height: 0;
    padding: 0;
}

.subtitle-block + .add-block-button {
    margin-top: -1px;
    margin-bottom: 1px;
}

.subtitle-block + .add-block-button:hover {
    opacity: 1;
}

.add-block-button:hover {
    opacity: 1;
}

.divider-line {
    display: flex;
    align-items: center;
    width: 100%;
    opacity: 0.6;
}

.divider-dash {
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, transparent 0%, #cbd5e1 50%, transparent 100%);
    margin: 0 8px;
}

.btn-add-block {
    background: transparent;
    border: none;
    border-radius: 3px;
    color: #94a3b8;
    font-size: 10px;
    font-weight: 400;
    cursor: pointer;
    padding: 2px 4px;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 2px;
    min-width: auto;
    height: auto;
    box-shadow: none;
    text-decoration: none;
    line-height: 1;
    opacity: 1;
    flex-shrink: 0;
}

.btn-add-block:hover {
    color: #64748b;
    background: rgba(100, 116, 139, 0.1);
    transform: none;
    text-decoration: none;
}

.btn-add-block:active {
    transform: none;
}

.btn-add-block::before {
    content: '+';
    font-weight: 600;
    margin-right: 1px;
    font-size: 9px;
}

.block-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.block-number {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    padding: 6px 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 12px;
    box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
}

.block-times {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #6b7280;
    font-size: 14px;
    font-family: 'Courier New', monospace;
}

.time-arrow {
    font-size: 16px;
    color: #9ca3af;
}

.block-actions {
    display: flex;
    gap: 6px;
}

.btn-action {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: all 0.2s ease;
    color: #6b7280;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-action:hover {
    background-color: #f3f4f6;
    color: #374151;
    transform: translateY(-1px);
}

.btn-action svg {
    width: 16px;
    height: 16px;
}

.edit-block:hover {
    background-color: #eff6ff;
    color: #3b82f6;
}

.delete-block:hover {
    background-color: #fef2f2;
    color: #ef4444;
}

.block-content {
    color: #374151;
    line-height: 1.6;
    font-size: 15px;
    padding: 8px 0;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
}

.block-content.editing {
    background: #f8fafc;
    border: 2px solid #4f46e5;
    border-radius: 8px;
    padding: 12px;
    outline: none;
}

.time-start.editing,
.time-end.editing {
    background: #f0f9ff;
    border: 1px solid #0ea5e9;
    border-radius: 4px;
    padding: 2px 4px;
    outline: none;
}

/* –†–µ–¥–∞–∫—Ç–æ—Ä */
.edit-mode {
    display: flex;
    flex-direction: column;
    gap: 20px;
    max-height: 100%;
    overflow-y: auto;
}

.editor-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.subtitle-editor {
    width: 100%;
    min-height: 300px;
    padding: 16px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.6;
    resize: vertical;
    background: white;
    transition: all 0.2s ease;
}

.subtitle-editor:focus {
    outline: none;
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.help-text {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    border: 1px solid #f59e0b;
    border-radius: 12px;
    padding: 16px;
    font-size: 14px;
    color: #92400e;
}

.help-icon {
    width: 20px;
    height: 20px;
    color: #f59e0b;
    flex-shrink: 0;
    margin-top: 2px;
}

.status-message {
    padding: 16px;
    border-radius: 12px;
    margin-top: 16px;
    font-weight: 500;
    border: 1px solid transparent;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.status-message.success {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
    border-color: #6ee7b7;
}

.status-message.error {
    background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
    color: #991b1b;
    border-color: #fca5a5;
}

.status-message.loading {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #1e40af;
    border-color: #93c5fd;
}

.status-message::before {
    content: '';
    width: 20px;
    height: 20px;
    border-radius: 50%;
    flex-shrink: 0;
}

.status-message.success::before {
    background: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23065f46'%3e%3ccircle cx='12' cy='12' r='10'/%3e%3cpath d='M9 12l2 2 4-4'/%3e%3c/svg%3e") center/contain no-repeat;
}

.status-message.error::before {
    background: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23991b1b'%3e%3ccircle cx='12' cy='12' r='10'/%3e%3cpath d='M15 9l-6 6M9 9l6 6'/%3e%3c/svg%3e") center/contain no-repeat;
}

.status-message.loading::before {
    background: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%231e40af'%3e%3ccircle cx='12' cy='12' r='10'/%3e%3cpath d='M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83'/%3e%3c/svg%3e") center/contain no-repeat;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Responsive design */
@media (max-width: 768px) {
    .project-layout {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .subtitle-column {
        height: 400px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    }
    
    .project-header-content {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
    }
    
    .project-title {
        font-size: 1.5rem;
    }
    
    .card-header {
        padding: 20px;
    }
    
    .card-content {
        padding: 20px;
    }
    
    .info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
        text-align: left;
    }
    
    .action-btn {
        justify-content: center;
    }
}

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
@media (max-width: 480px) {
    .subtitle-column {
        height: 350px; /* –ï—â–µ –º–µ–Ω—å—à–µ –Ω–∞ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    }
    
    .project-title {
        font-size: 1.25rem;
    }
    
    .card-header, .card-content {
        padding: 16px;
    }
}
</style>
</script>

<script>
// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
(function() {
    const status = '{{ project.status }}';
    if (status === 'processing' || status === 'draft') {
        setTimeout(() => location.reload(), 5000);
    }
})();
</script>

{% endblock %}
